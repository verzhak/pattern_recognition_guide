
\myparagraph{Программная библиотека OpenCV}

Одной из популярнейших библиотек, используемых для решения разнообразных задач компьютерного зрения, является библиотека OpenCV - Open Source Computer Vision Library \cite{opencv}, разработанная на языке программирования C++ и официально предоставляющая интерфейсы к языкам программирования C, C++, Python и Java.

Здесь и далее используется язык программирования C++.

Библиотека OpenCV является свободной открытой программной библиотекой, ядро команды разработчиков которой составляют российские программисты из центра разработки программного обеспечения Intel, расположенного в Нижнем Новгороде.

Библиотека OpenCV может быть использована в ОС GNU / Linux, ОС семейства BSD, ОС семейства Windows, MacOS.

В сети Интернет доступна online - справка по библиотеке OpenCV \cite{opencv-help}.

\mysubparagraph{Подключение библиотеки к программе}

% \input{lab/\discipline/\thelr/inst-linux}
\input{lab/\discipline/\thelr/inst-win}

Для подключения библиотеки к программе необходимо выполнить следующие действия:

\begin{itemize}
		
	\item подключить к программе заголовочный файл opencv2/opencv.hpp;
	\item сделать доступными в программе имена из пространства имен \verb|cv|\footnote{Для подключения к программе пространства имен cv необходимо воспользоваться директивой using namespace cv}.

\end{itemize}

\mysubparagraph{Внутреннее представление изображений}

Каждое изображение представляется библиотекой OpenCV в виде матрицы - объекта класса \verb|Mat|.

Каждый элемент матрицы соответствует одному пикселю изображения.

В зависимости от количества и типа каналов изображения каждый элемент матрицы может иметь следующие типы данных:

\begin{itemize}

	\item \verb|unsigned char| - в случае одноканального 8-ми битного беззнакового изображения;
	\item \verb|int| - в случае одноканального 32-х (64-х) битного знакового изображения\footnote{Как правило, тип int не используется для изображений, но применяется для матриц с целочисленными знаковыми элементами.};
	\item \verb|float| - в случае одноканального вещественного (одинарной точности) изображения;
	\item \verb|Vec3b| - в случае 3-х канального 8-ми битного беззнакового изображения.

	Гарантируется, что класс \verb|Vec3b| перегружает оператор \verb|[ ]|, позволяющий получить доступ к целевому каналу по его индексу (2 - красный, 1 - зеленый, 0 - синий).

\end{itemize}

Для получения размеров изображения необходимо воспользоваться методом \verb|Size()| класса \verb|Mat|. Прототип данного метода приведен в листинге \ref{listing:1:size}.

\mylistingbegin{1:size}{Получение размеров изображения с помощью метода Size() класса Mat}
\begin{lstlisting}

Size Mat::size();

\end{lstlisting}
\mylistingend

Метод \verb|Size()| класса \verb|Mat| возвращает объект класса \verb|Size|, поля \verb|height| и \verb|width| которого содержат соответственно количество строк в изображении и число пикселей в каждой из строк изображения.

Для доступа к пикселю изображения может быть использован метод \verb|at()| класса \verb|Mat|. Примеры использования метода \verb|at()| приведены в листинге \ref{listing:1:at}.

\mylistingbegin{1:at}{Доступ к пикселю изображения с помощью метода at() класса Mat}
\begin{lstlisting}

unsigned char ch_uc = src_uc.at<unsigned char>(row, col);
dst_uc.at<unsigned char>(row, col) = ch_uc;

float ch_flt = src_flt.at<float>(row, col);
dst_flt.at<float>(row, col) = ch_flt;

Vec3b ch_3b = src_3b.at<Vec3b>(row, col);
dst_3b.at<Vec3b>(row, col) = ch_3b;

\end{lstlisting}
\mylistingend

Метод \verb|at()| является шаблонным - та или иная его версия может быть вызвана в зависимости от типа и количества каналов изображения.

Метод \verb|at()| принимает на вход номер строки изображения и номер целевого пикселя в данной строке (параметры \verb|row| и \verb|col| соответственно) и возвращает ссылку на пиксель - значение яркостей пикселя может быть прочитано или обновлено с помощью данной ссылки.

\mysubparagraph{Создание и уничтожение изображения}

Для создания нового изображения можно воспользоваться конструктором класса \verb|Mat|, прототип одной из версий которого приведен в листинге \ref{listing:1:mat:create}.

\mylistingbegin{1:mat:create}{Создание нового изображения с помощью конструктора класса Mat}
\begin{lstlisting}

Mat::Mat(int rows, int cols, int type);

\end{lstlisting}
\mylistingend

Версия конструктора класса \verb|Mat|, приведенная в листинге \ref{listing:1:mat:create}, обладает следующими параметрами:

\begin{itemize}

	\item \verb|rows| - количество строк в изображении;
	\item \verb|cols| - количество пикселей в каждой из строк изображения;
	\item \verb|type| - количество и тип каналов изображения.

	Параметр \verb|type| может принимать, кроме всего прочего, следующие значения:

	\begin{itemize}

		\item \verb|CV_8UC1| - будет создано одноканальное 8-ми битное беззнаковое изображение;
		\item \verb|CV_8UC3| - будет создано 3-х канальное 8-ми битное беззнаковое изображение;
		\item \verb|CV_32SC1| - будет создано одноканальное 32-х битное знаковое изображение;
		\item \verb|CV_32FC1| - будет создано одноканальное вещественное (одинарная точность) изображение.

	\end{itemize}

\end{itemize}

Класс \verb|Mat| обладает также конструктором без параметров.

Уничтожение изображения (и любой матрицы вообще) выполняется деструктором объекта класса \verb|Mat|.

\mysubparagraph{Загрузка и сохранение изображений}

Библиотека OpenCV реализует Octave / MATLAB - подобный интерфейс загрузки и сохранения изображений.

Для загрузки изображения необходимо воспользоваться функцией \verb|imread()|, прототип которой приведен в листинге \ref{listing:1:imread}.

\mylistingbegin{1:imread}{Загрузка изображения с помощью функции imread()}
\begin{lstlisting}

Mat imread(const string & filename, int flags = 1)

\end{lstlisting}
\mylistingend

Функция \verb|imread()| обладает следующими параметрами:

\begin{itemize}

	\item \verb|filename| - строка, содержащая путь и имя файла с загружаемым изображением.

	Класс \verb|string| определен в Стандартной библиотеке шаблонов (Standard Template Library; STL; часть стандартной библиотеки языка программирования C++) и становится доступным после подключения к проекту заголовочного файла string и пространства имен std;

	\item \verb|flags| - флаг, указывающий количество каналов в загружаемом изображении.

	Параметр \verb|flags| может принимать следующие значения:

	\begin{itemize}

		\item $> 0$ - изображение будет загружено как 3-х канальное (если загружается одноканальное изображение, то единственный канал будет размножен);
		\item $0$ - изображение будет загружено как одноканальное (если загружается 3-х канальное изображение, то будет загружен только один из каналов);
		\item $< 0$ - изображение будет загружено <<как есть>>.

	\end{itemize}

\end{itemize}

Функция \verb|imread()| возвращает матрицу, описывающую изображение, - в случае, если загрузить изображение не удалось, функция вернет пустую матрицу (поле \verb|data| описателя матрицы будет установлено в \verb|NULL|).

Для сохранения изображения необходимо воспользоваться функцией \verb|imwrite()|, прототип которой приведен в листинге \ref{listing:1:imwrite}.

\mylistingbegin{1:imwrite}{Сохранение изображения с помощью функции imwrite()}
\begin{lstlisting}

bool imwrite(const string & filename, Mat image);

\end{lstlisting}
\mylistingend

Функция \verb|imwrite()| обладает следующими параметрами:

\begin{itemize}

	\item \verb|filename| - путь и имя результирующего файла;
	\item \verb|image| - матрица сохраняемого изображения.

\end{itemize}

Функция \verb|imwrite()| возвращает \verb|true| в случае успешного сохранения изображения в файл и \verb|false| в противном случае.

\mysubparagraph{Получение фрагмента изображения}

Для получения части изображения можно воспользоваться оператором \verb|()|, перегруженным в классе \verb|Mat|. Пример получения фрагмента изображения приведен в листинге \ref{listing:1:range}.

\mylistingbegin{1:range}{Получение фрагмента изображения с помощью оператора ()}
\begin{lstlisting}

Mat frame = src(Range(from_row, to_row), Range(from_col, to_col))

\end{lstlisting}
\mylistingend

В листинге \ref{listing:1:range} из матрицы \verb|src| исходного изображения в матрицу \verb|frame| копируются столбцы с \verb|from_col| по \verb|to_col - 1| строк с \verb|from_row| по \verb|to_row - 1|.

\mysubparagraph{Вывод изображений на экран}

Для вывода изображения на экран необходимо выполнить следующие действия:

\begin{enumerate}

	\item создать новое окно.
	
	Для создания нового окна необходимо воспользоваться функцией \verb|namedWindow()|, прототип которой приведен в листинге \ref{listing:1:namedwindow}.

	\mylistingbegin{1:namedwindow}{Создание нового окна с помощью функции namedWindow()}
	\begin{lstlisting}

	void namedWindow(const string & winname, CV_WINDOW_NORMAL);

	\end{lstlisting}
	\mylistingend

	В качестве значения параметра \verb|winname| в функцию \verb|namedWindow()| передается строка с названием нового окна;

	\item вывести изображение в окно.

	Для вывода изображения в окно необходимо воспользоваться функцией \verb|imshow()|, прототип которой приведен в листинге \ref{listing:1:imshow}.

	\mylistingbegin{1:imshow}{Вывод изображения в окно с помощью функции imshow()}
	\begin{lstlisting}

	void imshow(const string & winname, Mat image);

	\end{lstlisting}
	\mylistingend

	Функция \verb|imshow()| обладает следующими параметрами:

	\begin{itemize}

		\item \verb|winname| - строка с названием окна;
		\item \verb|image| - описатель матрицы изображения.

	\end{itemize}

\end{enumerate}

Для закрытия всех открытых окон необходимо воспользоваться функцией \linebreak \verb|destroyAllWindows()|, не имеющей параметров.

Очевидно, что перед остановом программы и закрытием всех окон необходимо некоторое время подержать их открытыми, для чего нужно воспользоваться функцией \verb|waitKey()|, прототип которой приведен в листинге \ref{listing:1:waitkey}.

\mylistingbegin{1:waitkey}{Ожидание нажатия клавиши с помощью функции waitKey()}
\begin{lstlisting}

char waitKey();

\end{lstlisting}
\mylistingend

Функция \verb|waitKey()| приостанавливает выполнение программы до тех пор, пока не будет нажата какая-либо клавиша, код которой функция \verb|waitKey()| возвращает в вызывающую подпрограмму.

